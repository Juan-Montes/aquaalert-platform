name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:        # permite disparar manualmente desde GitHub

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Deploy via SSH al VPS
  # Secrets requeridos en GitHub â†’ Settings â†’ Secrets:
  #   VPS_HOST      â†’ IP o dominio del servidor
  #   VPS_USER      â†’ usuario SSH (ej: ubuntu)
  #   VPS_SSH_KEY   â†’ clave privada SSH (cat ~/.ssh/id_rsa)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest

    # Solo corre si hay un VPS configurado
    # Si VPS_HOST estÃ¡ vacÃ­o, el job se salta sin error
    if: ${{ vars.DEPLOY_ENABLED == 'true' }}

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy via SSH
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            cd ~/aquaalert-platform

            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main

            echo "ðŸ³ Rebuilding containers..."
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --build

            echo "ðŸ§¹ Cleaning old images..."
            docker image prune -f

            echo "âœ… Deploy complete!"
            docker compose -f docker-compose.prod.yml ps
          ENDSSH

      - name: ðŸ“¬ Notify deploy (optional)
        if: always()
        run: |
          echo "Deploy status: ${{ job.status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
